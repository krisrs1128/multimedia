<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Microbiome - Metabolome Mediation Analysis • multimedia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Microbiome - Metabolome Mediation Analysis">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">multimedia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IBD.html">Microbiome - Metabolome Mediation Analysis</a>
    </li>
    <li>
      <a href="../articles/illustration.html">Illustration with Nonlinear Effects</a>
    </li>
    <li>
      <a href="../articles/mindfulness.html">The Mindfulness Study</a>
    </li>
    <li>
      <a href="../articles/random.html">Quick Start with Random Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/krisrs1128/multimedia/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Microbiome - Metabolome Mediation Analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/krisrs1128/multimedia/blob/HEAD/vignettes/IBD.Rmd" class="external-link"><code>vignettes/IBD.Rmd</code></a></small>
      <div class="hidden name"><code>IBD.Rmd</code></div>

    </div>

    
    
<p>Joint microbiome-metabolome experiments can give a view into how
microbes shape their environments. <code>multimedia</code> lets us
analyze high-dimensional outcome and mediation variables simultaneously.
This allows us to analyze treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\to</annotation></semantics></math>
microbiome
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\to</annotation></semantics></math>
metabolome and treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\to</annotation></semantics></math>
metabolome
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>→</mo><annotation encoding="application/x-tex">\to</annotation></semantics></math>
microbiome paths. The methodology only allows us to analyze one kind of
path at a time; in any case, it’s impossible to completely disambiguate
the directionality of the association from a single timepoint without
prior knowledge. That said, the relationships that are uncovered from
either of these directions can already suggest novel microbe-metabolite
relationships.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stat.boogaart.de/compositions/" class="external-link">compositions</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/" class="external-link">ggdist</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vroom.r-lib.org" class="external-link">vroom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://krisrs1128.github.io/multimedia" class="external-link">multimedia</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20231222</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-processing">Data Processing<a class="anchor" aria-label="anchor" href="#data-processing"></a>
</h2>
<p>We’ll load data from the Borenstein Lab’s <a href="https://go.wisc.edu/582dhj" class="external-link">microbiome-metabolome curated data</a>
repository. This is a great resource that consistently documents each
study and ensures uniform data processing. Our data is from <a href="https://go.wisc.edu/14b4a2" class="external-link">Franzosa et al.’s</a> study of
intestinal bowel disease. We’ll treat disease status as the treatment,
the microbiome as mediators, and metabolites as the outcome, in the
spirit of that study’s discussion:</p>
<blockquote>
<p>Together, these findings suggest that yet-to-be characterized
molecules in the gut metabolome, linked to inflammation and ultimately
IBD, may be largely microbially derived or modified.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"VROOM_CONNECTION_SIZE"</span> <span class="op">=</span> <span class="fl">5e6</span><span class="op">)</span></span>
<span><span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/l015v0"</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">metabolites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/0t3gs3"</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/9z36wr"</span><span class="op">)</span></span></code></pre></div>
<p>We’ll filter quite aggressively so that the examples in this vignette
run quickly. We then compile everything into a
<code>mediation_data</code> object that organizes the treatment,
mediators, and outcomes. We apply a centered log transform to the
microbiome relative abundance and a log transform to the metabolite
expression levels. Note that I’ve hidden some of the preprocessing
functions (e.g., <code>simplify_tax_names</code>); these do what you
expect, and you can read them in the <code>.Rmd</code> source.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/compositions/man/clr.html" class="external-link">clr</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">filter_mean</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">simplify_tax_names</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metabolites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">metabolites</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">filter_mean</span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="fu">annotated_metabolites</span><span class="op">(</span><span class="va">metabolites</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">simplify_metab_names</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">metabolites</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">taxa</span>, <span class="va">metadata</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mediation_data.html">mediation_data</a></span><span class="op">(</span></span>
<span>    <span class="va">combined</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">metabolites</span><span class="op">)</span>,</span>
<span>    <span class="st">"Study.Group"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exper</span></span></code></pre></div>
<pre class="r-output"><code><span><span class="co">#&gt; [Mediation Data] </span></span>
<span><span class="co">#&gt; 220 samples with measurements for, </span></span>
<span><span class="co">#&gt; 1 treatment: Study.Group </span></span>
<span><span class="co">#&gt; 173 mediators: gSutterella, gMarvinbryantia, ... </span></span>
<span><span class="co">#&gt; 155 outcomes: m0031_phenyllactate, m0045_azelate, ...</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="lasso-approach">Lasso Approach<a class="anchor" aria-label="anchor" href="#lasso-approach"></a>
</h2>
<p>We will fit sparse regression models for each outcome so that, for
any metabolite, only a subset of microbes is expected to influence its
abundance.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multimedia.html">multimedia</a></span><span class="op">(</span><span class="va">exper</span>, <span class="fu"><a href="../reference/glmnet_model.html">glmnet_model</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/estimate.html">estimate</a></span><span class="op">(</span><span class="va">exper</span><span class="op">)</span></span></code></pre></div>
<p>We can have different direct effects depending on the treatment
assignments of the mediators. Here we’ll average over all mediator
settings and plot the features with the largest direct effects. Note
that the boxplots can reflect indirect effects as well, and this is why
the ordering below (based on direct effect estimate) doesn’t exactly
correspond to the distance between the boxplots.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD <span class="op">=</span> <span class="fu"><a href="../reference/direct_effect.html">direct_effect</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">exper</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    UC <span class="op">=</span> <span class="fu"><a href="../reference/direct_effect.html">direct_effect</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">exper</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">effect_summary</span>, .id <span class="op">=</span> <span class="st">"treatment"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vis_direct</span> <span class="op">&lt;-</span> <span class="va">direct</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">direct_effect</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="va">vis_direct</span><span class="op">)</span>, <span class="va">Study.Group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">Study.Group</span>, names_to <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">feature</span>, <span class="va">value</span>, <span class="va">median</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="va">Study.Group</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="st">"log(1 + intensity)"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Metabolite"</span>,</span>
<span>        fill <span class="op">=</span> <span class="st">"Group"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/lasso_direct-1.png" width="600" style="display: block; margin: auto;"></p>
<p>The block below calculates the analogous overall indirect effects.
We’re particularly interested in the difference between metabolites that
have strong indirect vs. direct effects, because these are expected to
have different relationships with the microbiome. To simplify this
comparison, we combine the top direct and indirect effects in the object
<code>top_effects</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indirect_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD <span class="op">=</span> <span class="fu"><a href="../reference/indirect_overall.html">indirect_overall</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">exper</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    UC <span class="op">=</span> <span class="fu"><a href="../reference/indirect_overall.html">indirect_overall</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">exper</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">top_direct</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">direct</span>, effect <span class="op">=</span> <span class="va">direct_effect</span><span class="op">)</span></span>
<span><span class="va">top_indirect</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">indirect_effect</span><span class="op">)</span>,</span>
<span>    effect <span class="op">=</span> <span class="va">indirect_effect</span></span>
<span><span class="op">)</span></span>
<span><span class="va">top_effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>direct <span class="op">=</span> <span class="va">top_direct</span>, indirect <span class="op">=</span> <span class="va">top_indirect</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"type"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vis_outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"m0181_hydrocinnamic_acid"</span>, <span class="st">"m1303_lithocholate"</span>,</span>
<span>    <span class="st">"m0036_creatinine"</span>, <span class="st">"m0253_sphingosine"</span>, <span class="st">"m1478_C182_CE"</span>,</span>
<span>    <span class="st">"m0295_arginine"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">top_effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">top_effects</span>, <span class="va">outcome</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">vis_outcomes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="va">type</span> <span class="op">==</span> <span class="st">"indirect"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">top_effects</span>, <span class="va">outcome</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">vis_outcomes</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="va">type</span> <span class="op">==</span> <span class="st">"direct"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>The plot below is an MDS of microbiome compositions where point sizes
represent metabolite abundances. Notice that the for indirect effects,
there is a clear relationship between metabolites and microbiome
composition. This is consistent with what we expect from a mediation
analysis: Indirect effects have to travel through the mediators, which
in this case are microbiome compositions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eig</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span>, <span class="va">k</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cmdscale.html" class="external-link">cmdscale</a></span><span class="op">(</span><span class="fu">dist</span><span class="op">(</span><span class="fu">mediators</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">)</span>, eig <span class="op">=</span> <span class="cn">TRUE</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mds</span><span class="op">$</span><span class="va">points</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">outcomes</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">[</span>, <span class="va">vis_outcomes</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">top_effects</span><span class="op">$</span><span class="va">outcome</span>,</span>
<span>        names_to <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>        values_to <span class="op">=</span> <span class="st">"abundance"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">top_effects</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>abundance_quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">abundance</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X1</span>, <span class="va">X2</span>, col <span class="op">=</span> <span class="va">Study.Group</span>, size <span class="op">=</span> <span class="va">abundance_quantile</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_area</a></span><span class="op">(</span>max_size <span class="op">=</span> <span class="fl">1.5</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"MDS1 [{eig(mds$eig, 1)}%]"</span><span class="op">)</span>,</span>
<span>        y <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"MDS2 [{eig(mds$eig, 2)}%]"</span><span class="op">)</span>,</span>
<span>        size <span class="op">=</span> <span class="st">"Metabolite Abundance Quantile"</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"Group"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">type</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="op">-</span><span class="va">abundance</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/unnamed-chunk-3-1.png" width="600" style="display: block; margin: auto;"></p>
<p>Pathwise indirect effects are those that appear when modifying the
treatment status for a single mediator. Unlike overall indirect effects,
they give us effects for individual mediator-outcome pairs. Now, instead
of averaging over mediator treatment assignments, we average over direct
edge treatment assignments. The block below is time-consuming, so if you
are following along, you can just read in the pre-computed result in the
next block.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># indirect_sorted &lt;- list(</span></span>
<span><span class="co">#   CD = indirect_pathwise(model, exper, 1, 3),</span></span>
<span><span class="co">#   UC = indirect_pathwise(model, exper, 2, 3)</span></span>
<span><span class="co"># ) |&gt;</span></span>
<span><span class="co">#   map_dfr(effect_summary, .id = "treatment")</span></span>
<span></span>
<span><span class="va">indirect_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/n04p94"</span><span class="op">)</span></span></code></pre></div>
<p>We can look at the effects which have the strongest indirect effects.
These make sense. For example, genus Biophila seems to have a negative
relationship with Taurine. Maybe that metabolite is produced by a
competitor? Or maybe the microbe eats the metabolite. In any case, IBD
seems to decrease the abundance of Biophila, which consequently
increases the abundance of the metabolite.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">indirect_sorted</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">-</span><span class="va">indirect_effect</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="../reference/plot_mediators.html">plot_mediators</a></span><span class="op">(</span><span class="va">exper</span>, treatment <span class="op">=</span> <span class="st">"Study.Group"</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">[[</span><span class="st">"CD"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/lasso_mediators_plot-1.png" width="600" style="display: block; margin: auto;"></p>
<p>We can create models where the effects have been deliberately
removed, which can be used for synthetic null testing. Here are
simulated samples from a “nullified” model without direct effects, a
full model with direct effects, and the original samples. To the extent
that the altered and fitted models differ, the direct treatment edge is
needed to improve model fit.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">altered</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/nullify.html">nullify</a></span><span class="op">(</span><span class="st">"T-&gt;Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/estimate.html">estimate</a></span><span class="op">(</span><span class="va">exper</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sample at original treatment assignments</span></span>
<span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_profile.html">setup_profile</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span>, <span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    real <span class="op">=</span> <span class="fu">outcomes</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span>,</span>
<span>    fitted <span class="op">=</span> <span class="fu">outcomes</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">model</span>, profile <span class="op">=</span> <span class="va">profile</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    altered <span class="op">=</span> <span class="fu">outcomes</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">altered</span>, profile <span class="op">=</span> <span class="va">profile</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">$</span><span class="va">Study.Group</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">direct</span><span class="op">$</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">name</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">direct</span><span class="op">$</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">samples</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">name</span>, fill <span class="op">=</span> <span class="va">treatment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">source</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/lasso_synthetic-1.png" width="600" style="display: block; margin: auto;"></p>
<p>How can we understand the uncertainty of the estimated models? One
approach is to form the bootstrap distribution of the effects that we
care about. It’s a little problematic to form bootstrap confidence
intervals for sparse regression. We can still interpret the full
bootstrap distributions, though. Effects that have large nonzero
components have more evidence of being real. This block is again slow,
so you can skip ahead and load a pre-computed version.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>direct <span class="op">=</span> <span class="va">direct_effect</span>, indirect <span class="op">=</span> <span class="va">indirect_overall</span><span class="op">)</span></span>
<span><span class="co"># inference &lt;- bootstrap(model, exper, fs, B = 1000)</span></span>
<span><span class="va">inference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/33ty1f"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter_outcomes</span> <span class="op">&lt;-</span> <span class="va">inference</span><span class="op">$</span><span class="va">indirect</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/effect_summary.html">effect_summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>indirect_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">indirect_effect</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">indirect_effect</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">inference</span><span class="op">$</span><span class="va">indirect</span>, <span class="va">outcome</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">filter_outcomes</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_slabinterval.html" class="external-link">stat_slabinterval</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">indirect_effect</span>, <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="va">indirect_effect</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.66</span>, <span class="fl">.95</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Indirect Effect"</span>, y <span class="op">=</span> <span class="st">"Metabolite"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filter_outcomes</span> <span class="op">&lt;-</span> <span class="va">inference</span><span class="op">$</span><span class="va">direct</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>direct_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">direct_effect</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">direct_effect</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">inference</span><span class="op">$</span><span class="va">direct</span>, <span class="va">outcome</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">filter_outcomes</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_slabinterval.html" class="external-link">stat_slabinterval</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">direct_effect</span>, <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="va">direct_effect</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.66</span>, <span class="fl">.95</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Direct Effect"</span>, y <span class="op">=</span> <span class="st">"Metabolite"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/lasso_bootstrap_vis-1.png" width="600" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="hurdle-lognormal-approach">Hurdle-Lognormal Approach<a class="anchor" aria-label="anchor" href="#hurdle-lognormal-approach"></a>
</h2>
<p>There are many zeros in the metabolites data, and sparse regression
is not the best approach for modeling these kinds of outcomes. Indeed,
we seem to have been most sensitive to indirect effects for highly
abundant metabolites (which are present in most samples), and this
raises the question of whether we might have missed true indirect
effects where that model’s linearity assumptions were not
appropriate.</p>
<p>As an alternative, we can work with a hurdle model, which explicitly
models zeros together with a nonnegative component. For this, we’ll
return the outcomes to their original (unlogged) scaling. We’ll apply a
BRMS hurdle model. So that this isn’t too slow during the indirect
effect estimation, I’ve further reduced the number of taxa and
metabolites in this analysis.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exper2</span> <span class="op">&lt;-</span> <span class="va">exper</span></span>
<span><span class="fu">outcomes</span><span class="op">(</span><span class="va">exper2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu">outcomes</span><span class="op">(</span><span class="va">exper2</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="fu">mediators</span><span class="op">(</span><span class="va">exper2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">mediators</span><span class="op">(</span><span class="va">exper2</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model &lt;- multimedia(</span></span>
<span><span class="co">#   exper2,</span></span>
<span><span class="co">#   brms_model(family = hurdle_lognormal())</span></span>
<span><span class="co"># ) |&gt;</span></span>
<span><span class="co">#   estimate(exper2)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/5e26op"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With the updated model, we can again compute pathwise indirect
effects. This time, we are more sensitive to metabolites that completely
vanish in the IBD (treatment) group. In all of the selected pairs, there
is also a treatment effect on microbe abundance. If this hadn’t been
present, and if the metabolite simply vanished, then that would be a
direct effect.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># indirect_sorted &lt;- indirect_pathwise(model, exper2) |&gt;</span></span>
<span><span class="va">indirect_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/j3z503"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/effect_summary.html">effect_summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mediators.html">plot_mediators</a></span><span class="op">(</span><span class="va">indirect_sorted</span>, <span class="va">exper2</span>, treatment <span class="op">=</span> <span class="st">"Study.Group"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/hurdle_indirect-1.png" width="600" style="display: block; margin: auto;"></p>
<p>We can see how well the hurdle model captured the zero pattern by
simulating data from the fitted model. There are a few outliers, which
is why I’ve trimmed the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>-axis.
The model has not captured the specific shape of the treatment group
scatterplots above, which tends to have regions with only zeros for some
metabolites. In retrospect, this is natural. The hurdle model can only
increase the zero probability as a linear function of species abundance.
We would need a step function preidctor to support the kinds of
transitions we see above.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_profile.html">setup_profile</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span>, <span class="fu">treatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">model</span>, profile <span class="op">=</span> <span class="va">profile</span>, pretreatment <span class="op">=</span> <span class="fu">pretreatments</span><span class="op">(</span><span class="va">exper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu">outcomes</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu">outcomes</span><span class="op">(</span><span class="va">exper2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mediators.html">plot_mediators</a></span><span class="op">(</span><span class="va">indirect_sorted</span>, <span class="va">samples</span>, treatment <span class="op">=</span> <span class="st">"Study.Group"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/hurdle_synthetic-1.png" width="600" style="display: block; margin: auto;"></p>
<p>Finally, we can look at direct effects from this model, which can be
compared to the analogous figure for the sparse regression. Now, many
outcomes with exact zeros under treatment have been detected, which is
consistent with the the hurdle model’s effectiveness in accurately
reflecting features that influence zero-inflation.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># direct &lt;- direct_effect(model, exper) |&gt;</span></span>
<span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://go.wisc.edu/3ik252"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/effect_summary.html">effect_summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="va">direct</span><span class="op">$</span><span class="va">outcome</span><span class="op">)</span>, <span class="va">Study.Group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">Study.Group</span>, names_to <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">feature</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">direct</span><span class="op">$</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">feature</span>, fill <span class="op">=</span> <span class="va">Study.Group</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBD_files/figure-html/hurdle_direct-1.png" width="600" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre class="r-output"><code><span><span class="co">#&gt; R version 4.4.1 (2024-06-14)</span></span>
<span><span class="co">#&gt; Platform: aarch64-apple-darwin20</span></span>
<span><span class="co">#&gt; Running under: macOS Sonoma 14.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: America/Chicago</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] multimedia_0.1.0            tidyselect_1.2.1           </span></span>
<span><span class="co">#&gt;  [3] SummarizedExperiment_1.35.1 Biobase_2.65.0             </span></span>
<span><span class="co">#&gt;  [5] GenomicRanges_1.57.1        GenomeInfoDb_1.41.1        </span></span>
<span><span class="co">#&gt;  [7] IRanges_2.39.2              S4Vectors_0.43.2           </span></span>
<span><span class="co">#&gt;  [9] BiocGenerics_0.51.0         MatrixGenerics_1.17.0      </span></span>
<span><span class="co">#&gt; [11] matrixStats_1.3.0           vroom_1.6.5                </span></span>
<span><span class="co">#&gt; [13] lubridate_1.9.3             forcats_1.0.0              </span></span>
<span><span class="co">#&gt; [15] stringr_1.5.1               dplyr_1.1.4                </span></span>
<span><span class="co">#&gt; [17] purrr_1.0.2                 readr_2.1.5                </span></span>
<span><span class="co">#&gt; [19] tidyr_1.3.1                 tibble_3.2.1               </span></span>
<span><span class="co">#&gt; [21] tidyverse_2.0.0             patchwork_1.2.0            </span></span>
<span><span class="co">#&gt; [23] glue_1.7.0                  ggdist_3.3.2               </span></span>
<span><span class="co">#&gt; [25] compositions_2.0-8          brms_2.21.0                </span></span>
<span><span class="co">#&gt; [27] Rcpp_1.0.13                 ggplot2_3.5.1              </span></span>
<span><span class="co">#&gt; [29] BiocStyle_2.33.1           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] shape_1.4.6.1           tensorA_0.36.2.1        jsonlite_1.8.8         </span></span>
<span><span class="co">#&gt;   [4] magrittr_2.0.3          TH.data_1.1-2           estimability_1.5.1     </span></span>
<span><span class="co">#&gt;   [7] farver_2.1.2            rmarkdown_2.28          fs_1.6.4               </span></span>
<span><span class="co">#&gt;  [10] zlibbioc_1.51.1         ragg_1.3.2              vctrs_0.6.5            </span></span>
<span><span class="co">#&gt;  [13] multtest_2.61.0         htmltools_0.5.8.1       S4Arrays_1.5.7         </span></span>
<span><span class="co">#&gt;  [16] progress_1.2.3          distributional_0.4.0    curl_5.2.1             </span></span>
<span><span class="co">#&gt;  [19] Rhdf5lib_1.27.0         SparseArray_1.5.31      rhdf5_2.49.0           </span></span>
<span><span class="co">#&gt;  [22] sass_0.4.9              StanHeaders_2.32.10     bslib_0.8.0            </span></span>
<span><span class="co">#&gt;  [25] htmlwidgets_1.6.4       desc_1.4.3              plyr_1.8.9             </span></span>
<span><span class="co">#&gt;  [28] sandwich_3.1-0          zoo_1.8-12              emmeans_1.10.4         </span></span>
<span><span class="co">#&gt;  [31] cachem_1.1.0            igraph_2.0.3            lifecycle_1.0.4        </span></span>
<span><span class="co">#&gt;  [34] iterators_1.0.14        pkgconfig_2.0.3         Matrix_1.7-0           </span></span>
<span><span class="co">#&gt;  [37] R6_2.5.1                fastmap_1.2.0           glmnetUtils_1.1.9      </span></span>
<span><span class="co">#&gt;  [40] GenomeInfoDbData_1.2.12 digest_0.6.37           colorspace_2.1-1       </span></span>
<span><span class="co">#&gt;  [43] textshaping_0.4.0       vegan_2.6-8             labeling_0.4.3         </span></span>
<span><span class="co">#&gt;  [46] timechange_0.3.0        fansi_1.0.6             httr_1.4.7             </span></span>
<span><span class="co">#&gt;  [49] abind_1.4-5             mgcv_1.9-1              compiler_4.4.1         </span></span>
<span><span class="co">#&gt;  [52] bit64_4.0.5             withr_3.0.1             backports_1.5.0        </span></span>
<span><span class="co">#&gt;  [55] inline_0.3.19           highr_0.11              QuickJSR_1.3.1         </span></span>
<span><span class="co">#&gt;  [58] pkgbuild_1.4.4          bayesm_3.1-6            MASS_7.3-61            </span></span>
<span><span class="co">#&gt;  [61] DelayedArray_0.31.11    biomformat_1.33.0       loo_2.8.0              </span></span>
<span><span class="co">#&gt;  [64] permute_0.9-7           tools_4.4.1             ape_5.8                </span></span>
<span><span class="co">#&gt;  [67] nlme_3.1-166            rhdf5filters_1.17.0     grid_4.4.1             </span></span>
<span><span class="co">#&gt;  [70] checkmate_2.3.2         cluster_2.1.6           reshape2_1.4.4         </span></span>
<span><span class="co">#&gt;  [73] ade4_1.7-22             generics_0.1.3          operator.tools_1.6.3   </span></span>
<span><span class="co">#&gt;  [76] gtable_0.3.5            tzdb_0.4.0              formula.tools_1.7.1    </span></span>
<span><span class="co">#&gt;  [79] data.table_1.16.0       hms_1.1.3               tidygraph_1.3.1        </span></span>
<span><span class="co">#&gt;  [82] utf8_1.2.4              XVector_0.45.0          foreach_1.5.2          </span></span>
<span><span class="co">#&gt;  [85] pillar_1.9.0            posterior_1.6.0         robustbase_0.99-4      </span></span>
<span><span class="co">#&gt;  [88] splines_4.4.1           lattice_0.22-6          bit_4.0.5              </span></span>
<span><span class="co">#&gt;  [91] survival_3.7-0          Biostrings_2.73.1       knitr_1.48             </span></span>
<span><span class="co">#&gt;  [94] gridExtra_2.3           V8_5.0.0                bookdown_0.40          </span></span>
<span><span class="co">#&gt;  [97] phyloseq_1.49.0         xfun_0.47               bridgesampling_1.1-2   </span></span>
<span><span class="co">#&gt; [100] DEoptimR_1.1-3          rstan_2.32.6            stringi_1.8.4          </span></span>
<span><span class="co">#&gt; [103] UCSC.utils_1.1.0        yaml_2.3.10             evaluate_0.24.0        </span></span>
<span><span class="co">#&gt; [106] codetools_0.2-20        BiocManager_1.30.24     cli_3.6.3              </span></span>
<span><span class="co">#&gt; [109] RcppParallel_5.1.9      xtable_1.8-4            systemfonts_1.1.0      </span></span>
<span><span class="co">#&gt; [112] munsell_0.5.1           jquerylib_0.1.4         coda_0.19-4.1          </span></span>
<span><span class="co">#&gt; [115] parallel_4.4.1          rstantools_2.4.0        pkgdown_2.1.0          </span></span>
<span><span class="co">#&gt; [118] prettyunits_1.2.0       bayesplot_1.11.1        Brobdingnag_1.2-9      </span></span>
<span><span class="co">#&gt; [121] glmnet_4.1-8            mvtnorm_1.2-6           scales_1.3.0           </span></span>
<span><span class="co">#&gt; [124] insight_0.20.3          crayon_1.5.3            rlang_1.1.4            </span></span>
<span><span class="co">#&gt; [127] multcomp_1.4-26</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kris Sankaran, Hanying Jiang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
