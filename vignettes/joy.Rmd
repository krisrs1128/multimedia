---
title: "Template for Joy Data Analysis"
output: rmdformats::readthedown
css: custom.css
vignette: >
  %\VignetteIndexEntry{joy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  warning = FALSE,
  message = FALSE, 
  comment = "#>",
  dev.args = list(bg = "transparent")
)

#knitr::knit_hooks$set(output = multimedia::ansi_aware_handler)
options(crayon.enabled = TRUE)
```

```{r setup}
library(multimedia)
library(tidyverse)
library(ggraph)

exper <- mediation_data(demo_joy(), "PHQ", "treatment", starts_with("ASV"))
```

### Specification

```{r}
model <- multimedia(exper) |>
  estimate(exper)

model
```

```{r}
ggraph(model@edges) +
  geom_edge_link(arrow = arrow()) +
  geom_node_label(aes(label = name, fill = node_type))
```

### Estimation

```{r}
model <- estimate(model, exper)
model@outcome@estimates
model@mediation@estimates
```

Sample the full model at original treatment.

```{r}
sample(model)
predict(model)
```

Sample at new mediator and outcome treatments. This assumes the same treatment
applies to all mediators and outcomes.

```{r}
levels <- c("Treatment", "Control")
t1 <- tibble(treatment = factor(rep(levels[1], 3), levels = levels))
t2 <- tibble(treatment = factor(rep(levels[2], 3), levels = levels))
profile <- setup_profile(model, t1, t2)
sample(model, profile)
```

Here is a generalization that allows different treatments for individual
mediators and outcomes.

```{r}
profile@t_mediator[["ASV1"]]$treatment <- "Control"
sample(model, profile = profile)
predict(model, profile = profile)
```

We can also contrast different samples.

```{r}
contrast_predictions(model, profile, profile)
contrast_samples(model, profile, profile)
```


### Effects

This covers the case of one treatment with two levels. Will need to test a few
more general cases:

* One treatment, many categorical levels.
* Multiple treatments, many categorical levels.
* One treatment, continuous.
* Multiple treatments, continuous.

```{r}
direct_effect(model)
indirect_overall(model)
indirect_pathwise(model)
```

```{r}
model <- multimedia(exper,  glmnet_model(lambda = seq(0.1, 1, 0.01))) |>
  estimate(exper)

direct_effect(model)
indirect_overall(model)
indirect_pathwise(model)
```

```{r}
model <- multimedia(exper,  brms_model()) |>
  estimate(exper)

direct_effect(model)
indirect_overall(model)
indirect_pathwise(model)
```

Here is an example using the logistic normal multinomial as the outcome model.

```{r}
exper <- mediation_data(demo_police(), starts_with("ASV"), "treatment", starts_with("Diet"))
model <- multimedia(exper, lnm_model()) |>
  estimate(exper)
```

```{r}
profile <- setup_profile(model, t1, t2)
y_star <- sample(model, profile, depth = 100)
p_hat <- predict(model, profile)
```

The direct and indirect effects are on a relative abundance scale.

```{r}
direct_effect(model)
indirect_overall(model)
indirect_pathwise(model)
```

