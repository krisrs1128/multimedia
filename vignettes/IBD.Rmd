---
title: "IBD"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{IBD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(brms)
library(compositions)
library(glue)
library(patchwork)
library(tidyverse)
library(vroom)
library(multimedia)
theme_set(theme_bw())
set.seed(20231222)
```

### Load and Preprocess Data

This loads data from the microbiome-metabolome-curated data repository.

```{r}
Sys.setenv("VROOM_CONNECTION_SIZE" = 5e6)
taxa <- read_tsv("https://raw.githubusercontent.com/borenstein-lab/microbiome-metabolome-curated-data/main/data/processed_data/FRANZOSA_IBD_2019/genera.tsv")[, -1]
metabolites <- read_tsv("https://raw.githubusercontent.com/borenstein-lab/microbiome-metabolome-curated-data/main/data/processed_data/FRANZOSA_IBD_2019/mtb.tsv")[, -1]
metadata <- read_tsv("https://github.com/borenstein-lab/microbiome-metabolome-curated-data/raw/main/data/processed_data/FRANZOSA_IBD_2019/metadata.tsv")
```

Here are some preprocessing functions.

```{r}
filter_mean <- function(x, threshold = 4) {
  x[, colMeans(x) > threshold]
}

simplify_tax_names <- function(x) {
  colnames(x) <- colnames(x) |>
    str_extract("g__.*+") |>
    str_replace("g__", "g") |>
    str_remove_all("[[:punct:]]")
  x
}

simplify_metab_names <- function(x) {
  colnames(x) <- colnames(x) |>
    str_remove_all("[[:punct:|NA| |\\.|\\/|\\*|,]]") |>
    str_replace_all("-", "_")
  x
}
```

We'll filter quite aggressively so that the examples in this vignette don't take
too long. We then compile everything into a `mediation_data` object that
organizes the treatment, mediators, and outcomes.

```{r}
taxa <- clr(taxa) |>
  filter_mean(threshold = 4) |>
  simplify_tax_names()

metabolites <- log(1 + metabolites) |>
  filter_mean(threshold = 7) |>
  simplify_metab_names()
  
combined <- metabolites |>
  bind_cols(taxa, metadata) |>
  mutate(treatment = ifelse(Study.Group == "Control", "control", "treatment")) |>
  as_tibble()

exper <- mediation_data(
  combined, 
  colnames(metabolites),
  "treatment",
  colnames(taxa)
)
```

### Lasso Approach

First let's fit sparse regression models for each outcome.

```{r}
model <- multimedia(exper, glmnet_model(lambda = 0.1)) |>
  estimate(exper)
```

We can have different direct effects depending on the setting of the mediators.
Here we'll average over all mediator settings and plot the features with the
largest direct effects.

```{r, eval = FALSE}
direct <- direct_effect(model, exper) |>
  group_by(outcome) |>
  summarise(direct_effect = mean(direct_effect)) |>
  slice_max(abs(direct_effect), n = 10) |>
  arrange(direct_effect)

combined |>
  select(any_of(direct$outcome), treatment) |>
  pivot_longer(-treatment, names_to = "feature") |>
  mutate(feature = factor(feature, levels = rev(direct$outcome))) |>
  ggplot() +
  geom_boxplot(aes(value, feature, fill = treatment))
```

Pathwise indirect effects are those that appear when modifying the treatment
status for a single mediator. Unlike overall indirect effects, they give us
effects for individual mediator-outcome pairs. Here we'll average over the
direct treatment settings

```{r}
indirect <- indirect_pathwise(model, exper)
indirect_sorted <- indirect |>
  group_by(outcome, mediator ) |>
  summarise(indirect_effect = mean(indirect_effect)) |>
  ungroup() |>
  slice_max(abs(indirect_effect), n = 12) |>
  arrange(indirect_effect)
```

We have a small helper for visualizing the indirect effects.

```{r, fig.width = 12, fig.height = 9}
plot_mediators(indirect_sorted, exper)
```

We can create models where the effects have been deliberately removed. This can
be useful for synthetic null testing, for example. Here are simulated samples
from a "nullified" model without direct effects, a full model with direct
effects, and the original samples.

```{r}
altered <- model |>
  nullify("T->Y") |>
  estimate(exper)

profile <- setup_profile(model, exper@treatments, exper@treatments)
samples <- list(
  real = exper@mediators,
  fitted = sample(model, profile = profile)$mediators,
  altered = sample(altered, profile = profile)$mediators
) |>
  bind_rows(.id = "source") |>
  bind_cols(treatment = rep(exper@treatments$treatment, 3)) |>
  pivot_longer(starts_with("g"))

ggplot(samples) +
  geom_boxplot(aes(value, reorder(name, value), fill = treatment)) +
  facet_wrap(~ source)
```

How can we understand the uncertainty of the estimated models? One approach is
to form the bootstrap distribution of the effects that we care about. It's a
little problematic to form bootstrap CI's for sparse regression. We can still
interpret the full bootstrap distributions, though. Effects that have large
nonzero components have more evidence of being real.

```{r}
fs <- list(direct = direct_effect, indirect = indirect_overall)
inference <- bootstrap(model, exper, fs)
ggplot(inference$indirect) +
  stat_slabinterval(
    aes(indirect_effect, reorder(outcome, indirect_effect, median)),
    .width = c(.66, .95)
  ) 

ggplot(inference$direct) +
  stat_pointinterval(
    aes(direct_effect, reorder(outcome, direct_effect, median)),
    .width = c(.66, .95)
  )
```

### Zero-Inflated Gaussian Approach

Ideally, we could also model the zeros. One idea is to apply a hurdle lognormal
model, since, for the nonnegative part, glmnet is implicitly assuming normal
errors in the log space. We can do this by returning to the original scaling and
then applying a BRMS model.

```{r}
exper2 <- exper
exper2@outcomes <- exp(exper2@outcomes) - 1
exper2@mediators <- exper2@mediators[, 1:15]
exper2@outcomes <- exper2@outcomes[, 1:40]
model <- multimedia(
  exper2,
  brms_model(family = hurdle_lognormal(), warmup = 500, iter = 1500, refresh = 0)
  )|>
  estimate(exper2)
```

Let's again get pathwise indirect effects. This is relatively slow, since
prediction in BRMS models takes time, and we need to do predictions across all
outcomes and when substituting all mediators.

```{r}
indirect <- indirect_pathwise(model)
indirect_sorted <- indirect |>
  group_by(outcome, mediator) |>
  summarise(indirect_effect = mean(indirect_effect)) |>
  arrange(-abs(indirect_effect))
```

```{r, fig.width = 12, fig.height = 9}
plot_mediators(indirect_sorted, exper2)
```

Let's see how the simulated data look in the same scatterplots.

```{r, fig.width = 12, fig.height = 9}
profile <- setup_profile(model, exper@treatments, exper@treatments)
samples <- sample(model, profile = profile, pretreatment = exper@pretreatments)
colnames(samples@outcomes) <- colnames(exper2@outcomes)
p <- plot_mediators(indirect_sorted, samples)
p$patches[[1]] <- map(p$patches[[1]], ~ . + ylim(0, 1e5))
p
```

We can also look at direct effects.

```{r}
direct <- direct_effect(model, exper)
direct_sorted <- direct |>
  group_by(outcome) |>
  summarise(direct_effect = mean(direct_effect)) |>
  slice_max(abs(direct_effect), n = 10) |>
  arrange(-abs(direct_effect))

combined |>
  select(any_of(direct_sorted$outcome), treatment) |>
  pivot_longer(-treatment, names_to = "feature") |>
  mutate(feature = factor(feature, levels = rev(direct_sorted$outcome))) |>
  ggplot() +
  geom_boxplot(aes(value, feature, fill = treatment))
```
